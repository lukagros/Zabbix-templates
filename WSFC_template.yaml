zabbix_export:
  version: '6.4'
  template_groups:
    - uuid: 4e2a9a99d54945dd8c61fc5ff1c86745
      name: 'HPB Templates/Microsoft/Windows Failover Cluster'
  templates:
    - uuid: c55dbf2f2085408db2223866deb4e993
      template: 'Microsoft Windows Failover Cluster Service WSFC - PS'
      name: 'Microsoft Windows Failover Cluster Service WSFC - PS'
      description: |
        This template uses Zabbix Agent because it does not work on Zabbix Agent (Active)
        zabbix.conf on host server must have AllowKey=system.run[*]
        !!Careful, powershell runs under Agent Service User context
        Even after powershell optimization, it takes a lot of resources to get the data.!!
      vendor:
        name: LG
        version: 6.4-0
      groups:
        - name: 'HPB Templates/Microsoft/Windows Failover Cluster'
      items:
        - uuid: 22fe786514564239a60caf52fa94afcf
          name: 'Failover Event logs'
          type: ZABBIX_ACTIVE
          key: 'eventlog[System,,"Warning|Error|Critical","FailoverClustering"]'
          delay: 5m
          value_type: LOG
          tags:
            - tag: application
              value: 'Failover Cluster'
            - tag: application
              value: WSFC
            - tag: component
              value: EventLog
          triggers:
            - uuid: 1092f6b795f24e2687b14c2074605902
              expression: |
                logseverity(/Microsoft Windows Failover Cluster Service WSFC - PS/eventlog[System,,"Warning|Error|Critical","FailoverClustering"])>1
                and nodata(/Microsoft Windows Failover Cluster Service WSFC - PS/eventlog[System,,"Warning|Error|Critical","FailoverClustering"],1800s)=0
              name: 'Failover Cluster Event logs {HOST.NAME}'
              opdata: '{ITEM.LASTVALUE1}'
              priority: WARNING
              description: |
                Warning Failover Cluster Log
                1 - Information, 2 - Warning, 4 - Error, 7 - Failure Audit, 8 - Success Audit, 9 - Critical, 10 - Verbose
              manual_close: 'YES'
              tags:
                - tag: Application
                  value: WSFC
      discovery_rules:
        - uuid: 55c618823cdb4f55a9aca9e6662b3754
          name: 'Cluster Role Discovery'
          key: 'system.run[[powershell.exe -NoProfile -ExecutionPolicy Bypass -Command "@{data=@(Get-ClusterGroup |Where-Object {$_.Name -ne ''Available Storage'' -and $_.Name -ne ''Cluster Group''}|Select-object @{n=''{#ROLENAME}'';e={$_.Name}},@{n=''{#ROLEID}'';e={$_.Id}})}|ConvertTo-Json -Compress"]]'
          delay: 12h
          lifetime: 7d
          item_prototypes:
            - uuid: b0fbabec462046788bd26c78be69bebc
              name: 'Role [{#ROLENAME}] RAW'
              key: 'system.run[[powershell.exe -NoProfile -ExecutionPolicy Bypass -Command "Get-ClusterGroup -Name ''{#ROLENAME}'' |Select-Object State,@{n=(''OwnerNode'');e={$_.ownerNode.nodeName}} |ConvertTo-Json -Compress"]]'
              delay: 15m
              value_type: TEXT
              preprocessing:
                - type: DISCARD_UNCHANGED_HEARTBEAT
                  parameters:
                    - 45m
              tags:
                - tag: application
                  value: WSFC
                - tag: component
                  value: role
            - uuid: f5e6d3f6384745dc80dcb1e9fd5480f2
              name: 'Role [{#ROLENAME}] Owner Node'
              type: DEPENDENT
              key: 'wfcs.cluster.role.ownernode[{#ROLEID}]'
              value_type: CHAR
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - $..OwnerNode.first()
                - type: DISCARD_UNCHANGED
              master_item:
                key: 'system.run[[powershell.exe -NoProfile -ExecutionPolicy Bypass -Command "Get-ClusterGroup -Name ''{#ROLENAME}'' |Select-Object State,@{n=(''OwnerNode'');e={$_.ownerNode.nodeName}} |ConvertTo-Json -Compress"]]'
              tags:
                - tag: application
                  value: WSFC
                - tag: component
                  value: role
            - uuid: 7356a51949ef40a9925f4bf5ab36600f
              name: 'Role [{#ROLENAME}] State'
              type: DEPENDENT
              key: 'wfcs.cluster.role.state[{#ROLEID}]'
              value_type: CHAR
              valuemap:
                name: 'WSFC Cluster Role State'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - $..State.first()
                - type: DISCARD_UNCHANGED
              master_item:
                key: 'system.run[[powershell.exe -NoProfile -ExecutionPolicy Bypass -Command "Get-ClusterGroup -Name ''{#ROLENAME}'' |Select-Object State,@{n=(''OwnerNode'');e={$_.ownerNode.nodeName}} |ConvertTo-Json -Compress"]]'
              tags:
                - tag: application
                  value: WSFC
                - tag: component
                  value: role
              trigger_prototypes:
                - uuid: c3046c1659a64596a630d43ac690ee8e
                  expression: 'last(/Microsoft Windows Failover Cluster Service WSFC - PS/wfcs.cluster.role.state[{#ROLEID}],#1)<>0'
                  name: 'Role [{#ROLENAME}] State'
                  opdata: '{ITEM.LASTITEM1}'
                  priority: AVERAGE
                  manual_close: 'YES'
                  tags:
                    - tag: Application
                      value: WSFC
          preprocessing:
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 1d
        - uuid: f7922a5f10e04d46abe2d7d497087be2
          name: 'Cluster Network Discovery'
          key: 'system.run[[powershell.exe -NoProfile -ExecutionPolicy Bypass -Command "@{data=@(Get-ClusterNode |Get-ClusterNetworkInterface |Select-Object @{n=''{#CLUSTERNETWORK}'';e={$($_.Name)}},@{n=''{#CLUSTERNETWORKID}'';e={$($_.ID)}})}|ConvertTo-Json -Compress"]]'
          delay: 12h
          lifetime: 7d
          item_prototypes:
            - uuid: b5121065c66c47f9afdb2698bd132d9c
              name: 'Network [{#CLUSTERNETWORK}] State'
              key: 'system.run[[powershell.exe -NoProfile -ExecutionPolicy Bypass -Command "(Get-ClusterNode |Get-ClusterNetworkInterface -Name ''{#CLUSTERNETWORK}'').State"]]'
              delay: 15m
              value_type: TEXT
              preprocessing:
                - type: DISCARD_UNCHANGED_HEARTBEAT
                  parameters:
                    - 45m
              tags:
                - tag: application
                  value: WSFC
                - tag: component
                  value: network
              trigger_prototypes:
                - uuid: e89d6b4cba2f4229a61e281b401dab68
                  expression: 'last(/Microsoft Windows Failover Cluster Service WSFC - PS/system.run[[powershell.exe -NoProfile -ExecutionPolicy Bypass -Command "(Get-ClusterNode |Get-ClusterNetworkInterface -Name ''{#CLUSTERNETWORK}'').State"]])<>"Up"'
                  name: 'Cluster Network {#CLUSTERNETWORK} State'
                  priority: WARNING
                  description: 'If Network Not UP(3)'
                  tags:
                    - tag: Application
                      value: WSFC
          preprocessing:
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 1d
        - uuid: ee598069f1924866b6b76a21539994fc
          name: 'Cluster Node Discovery'
          key: 'system.run[[powershell.exe -NoProfile -ExecutionPolicy Bypass -Command "@{data=@(Get-ClusterNode |Select-object @{n=''{#NODENAME}'';e={$_.Name}},@{n=''{#NODEID}'';e={$_.Id}})}|ConvertTo-json -Compress"]]'
          delay: 12h
          lifetime: 7d
          item_prototypes:
            - uuid: 0c8f50ed008c4f81bebb4d7c59343c35
              name: 'Node [{#NODENAME}] State'
              key: 'system.run[[powershell.exe -NoProfile -ExecutionPolicy Bypass -Command "(Get-ClusterNode -Name ''{#NODENAME}'').State"]]'
              delay: 15m
              value_type: TEXT
              preprocessing:
                - type: DISCARD_UNCHANGED_HEARTBEAT
                  parameters:
                    - 45m
              tags:
                - tag: application
                  value: WSFC
                - tag: component
                  value: node
              trigger_prototypes:
                - uuid: a777fe3712744b08bc3d94edecffdfb5
                  expression: 'last(/Microsoft Windows Failover Cluster Service WSFC - PS/system.run[[powershell.exe -NoProfile -ExecutionPolicy Bypass -Command "(Get-ClusterNode -Name ''{#NODENAME}'').State"]])<>"Up"'
                  name: 'Cluster Node {#CLUSTERNODE} State'
                  opdata: '{ITEM.LASTVALUE1}'
                  priority: AVERAGE
                  tags:
                    - tag: Application
                      value: WSFC
          preprocessing:
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 1d
        - uuid: b9787727580a449391a1c7259cb99fc9
          name: 'Cluster Resource Discovery'
          key: 'system.run[[powershell.exe -NoProfile -ExecutionPolicy Bypass -Command "@{data=@(Get-ClusterResource|Select-object @{n=''{#RESOURCENAME}'';e={$_.Name}},@{n=''{#RESOURCEID}'';e={$_.Id}},@{n=''{#RESOURCETYPE}'';e={$_.ResourceType}})}|ConvertTo-Json -Compress"]]'
          delay: 12h
          lifetime: 7d
          item_prototypes:
            - uuid: c0e10d28686e40f99638801ea9f5212c
              name: 'Resource [{#RESOURCENAME}] Type [{#RESOURCETYPE}] State'
              key: 'system.run[[powershell.exe -NoProfile -ExecutionPolicy Bypass -Command "(Get-ClusterResource -Name ''{#RESOURCENAME}'').State"]]'
              delay: 15m
              value_type: TEXT
              preprocessing:
                - type: DISCARD_UNCHANGED_HEARTBEAT
                  parameters:
                    - 45m
              tags:
                - tag: application
                  value: WSFC
                - tag: component
                  value: resource
              trigger_prototypes:
                - uuid: 97a45ba67557411b8f810f7aab7f6540
                  expression: 'last(/Microsoft Windows Failover Cluster Service WSFC - PS/system.run[[powershell.exe -NoProfile -ExecutionPolicy Bypass -Command "(Get-ClusterResource -Name ''{#RESOURCENAME}'').State"]])<>"Online"'
                  name: 'Resuorce [{#RESOURCENAME}] of Type [{#RESOURCENAME}] State'
                  opdata: '{ITEM.LASTVALUE1}'
                  priority: AVERAGE
                  tags:
                    - tag: Application
                      value: WSFC
          preprocessing:
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 1d
        - uuid: ed22bd0e42c942e181c1527ec52b2ef9
          name: 'Cluster Shared Volume Discovery'
          key: 'system.run[[powershell.exe -NoProfile -ExecutionPolicy Bypass -Command "@{data=@(Get-ClusterSharedVolume  |Select-Object @{n=''{#CLUSTERCSV}'';e={$($_.Name)}},@{n=''{#CLUSTERCSVID}'';e={$($_.ID)}})}|ConvertTo-Json -Compress"]]'
          delay: 12h
          lifetime: 7d
          item_prototypes:
            - uuid: f5b1f3d840544b3c8288cf11638c6d98
              name: 'Shared Volume [{#CLUSTERCSV}] Raw'
              key: 'system.run[[powershell.exe -NoProfile -ExecutionPolicy Bypass -Command "Get-ClusterSharedVolume -Name ''{#CLUSTERCSV}''|Select-Object Name,State,@{n=''OwnerNode'';e={$_.OwnerNode.NodeName}}|convertTo-Json -Compress"]]'
              delay: 15m
              value_type: TEXT
              preprocessing:
                - type: DISCARD_UNCHANGED
              tags:
                - tag: application
                  value: WSFC
                - tag: component
                  value: 'shared volume'
            - uuid: ba001ed5eb2f4b95a97ec3521c500f61
              name: 'Shared Volume [{#CLUSTERCSV}] Owner Node'
              type: DEPENDENT
              key: 'wfcs.cluster.csv.ownernode[{#CLUSTERCSV}.{#CLUSTERCSVID}]'
              value_type: CHAR
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - $..OwnerNode.first()
              master_item:
                key: 'system.run[[powershell.exe -NoProfile -ExecutionPolicy Bypass -Command "Get-ClusterSharedVolume -Name ''{#CLUSTERCSV}''|Select-Object Name,State,@{n=''OwnerNode'';e={$_.OwnerNode.NodeName}}|convertTo-Json -Compress"]]'
              tags:
                - tag: application
                  value: WSFC
                - tag: component
                  value: 'shared volume'
            - uuid: 51a40a2ea1344a49b7ef79e85d318ccd
              name: 'Shared Volume [{#CLUSTERCSV}] State'
              type: DEPENDENT
              key: 'wfcs.cluster.csv.state[{#CLUSTERCSV}.{#CLUSTERCSVID}]'
              value_type: CHAR
              valuemap:
                name: 'WSFC Cluster Disk State'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - $..State.first()
              master_item:
                key: 'system.run[[powershell.exe -NoProfile -ExecutionPolicy Bypass -Command "Get-ClusterSharedVolume -Name ''{#CLUSTERCSV}''|Select-Object Name,State,@{n=''OwnerNode'';e={$_.OwnerNode.NodeName}}|convertTo-Json -Compress"]]'
              tags:
                - tag: application
                  value: WSFC
                - tag: component
                  value: 'shared volume'
              trigger_prototypes:
                - uuid: 11e526aae19d402984379b9110708025
                  expression: 'last(/Microsoft Windows Failover Cluster Service WSFC - PS/wfcs.cluster.csv.state[{#CLUSTERCSV}.{#CLUSTERCSVID}],#1)<>2'
                  name: 'Shared Volume [{#CLUSTERCSV}] State'
                  opdata: '{ITEM.LASTITEM1}'
                  priority: WARNING
                  manual_close: 'YES'
                  tags:
                    - tag: Application
                      value: WFCS
          preprocessing:
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 1d
      tags:
        - tag: Service
          value: 'Failover Cluster'
      macros:
        - macro: '{$LLD_INTERVAL_LONG}'
          value: 24h
        - macro: '{$LLD_INTERVAL_MEDIUM}'
          value: 60m
        - macro: '{$LLD_INTERVAL_SHORT}'
          value: 3m
        - macro: '{$LLD_KEEP_PERIOD}'
          value: 60m
      valuemaps:
        - uuid: f0c28ee62cbf4f2c9b8727493ee5d5cf
          name: 'WSFC Cluster Disk State'
          mappings:
            - value: '2'
              newvalue: Online
        - uuid: c23fed397a5241fa928b80011b1825ae
          name: 'WSFC Cluster Network Role'
          mappings:
            - value: '3'
              newvalue: ClusterAndClient
            - value: '1'
              newvalue: Cluster
            - value: '0'
              newvalue: 'Not Used'
        - uuid: bb794b4ef87e485d9cacd3fc89842c74
          name: 'WSFC Cluster Network State'
          mappings:
            - value: '3'
              newvalue: Up
        - uuid: 464c4ce9c4724d13b52e1ba4f20b6cb1
          name: 'WSFC Cluster Node State'
          mappings:
            - value: '0'
              newvalue: Up
            - value: '1'
              newvalue: Down
        - uuid: 2dd61f24367f4a0cb4f1f0aebb759fe2
          name: 'WSFC Cluster Role State'
          mappings:
            - value: '0'
              newvalue: Online
            - value: '1'
              newvalue: Offline
